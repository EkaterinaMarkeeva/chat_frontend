!function(){"use strict";var e=async e=>{const t=new XMLHttpRequest,{method:s,url:a,data:n,callback:i}=e,d="https://chat-backend-neda.onrender.com";t.responseType="text";try{"GET"===s?(t.open(s,d+a),t.send()):(t.open(s,d+a),t.send(JSON.stringify(n)))}catch(e){i&&i(e)}t.addEventListener("load",(()=>{if(t.status>=200&&t.status<300)try{const e=JSON.parse(t.responseText);i(e)}catch(e){console.error(e)}else{const e=JSON.parse(t.responseText);i(e)}}))};class t{URL="";list(t){e({method:"GET",url:this.URL,callback:t})}get(t,s){e({method:"GET",url:this.URL+t.id,data:t,callback:s})}create(t,s){e({method:"POST",url:this.URL,data:t,callback:s})}update(t,s){e({method:"POST",url:this.URL+t.id,data:t,callback:s})}delete(t,s){e({method:"GET",url:this.URL+t.id,data:t,callback:s})}}class s extends t{URL="/new-user"}class a{constructor(e){this.target=e}createStartModal(){const e=document.createElement("div"),t=document.createElement("h2"),s=document.createElement("input"),a=document.createElement("button");e.classList.add("modal"),e.classList.add("form"),t.classList.add("modal-title"),s.classList.add("input"),a.classList.add("btn"),a.classList.add("modal-btn"),a.classList.add("btn-next"),t.textContent="Выберите псевдоним",a.textContent="Продолжить",s.name="name",s.type="text",a.addEventListener("click",this.target.onClick),e.appendChild(t),e.appendChild(s),e.appendChild(a),this.target.container.appendChild(e)}createError(e){const t=document.createElement("div"),s=document.createElement("h2"),a=document.createElement("button");t.classList.add("modal"),s.classList.add("modal-title"),a.classList.add("btn"),a.classList.add("modal-btn"),a.classList.add("btn-ok"),s.textContent=e,a.textContent="Ok",a.addEventListener("click",this.target.onClick),t.appendChild(s),t.appendChild(a),this.target.container.appendChild(t)}createChat(){const e=document.createElement("div"),t=document.createElement("div"),s=document.createElement("input");e.classList.add("chat__container"),t.classList.add("chat__messages-container"),s.classList.add("input"),s.classList.add("chat__messages-input"),s.type="text",s.addEventListener("keypress",this.target.onEnterChatHandler),t.appendChild(s),e.appendChild(t),this.target.container.appendChild(e)}createUserList(e){const t=document.querySelector(".chat__container"),s=document.createElement("div");s.classList.add("chat__userlist"),e&&e.forEach((e=>{const t=document.createElement("div"),a=document.createElement("div"),n=document.createElement("div");t.classList.add("chat__user"),a.classList.add("chat__user-circle"),n.classList.add("chat__user-name"),t.id=e.id,n.textContent=e.name,t.appendChild(a),t.appendChild(n),s.appendChild(t)})),t.prepend(s)}createCorrespondence(e){const t=document.querySelector(".chat__messages-container"),s=document.querySelector(".chat__messages-input");if(e){const a=document.createElement("div"),n=document.createElement("p"),i=document.createElement("div"),d=document.createElement("time"),c=document.createElement("p");a.classList.add("message__container"),i.classList.add("message__header"),n.classList.add("message__header_user-name"),d.classList.add("message__header_date"),c.classList.add("message__text-content"),n.textContent=e.name,d.textContent=new Date(Number(e.date)).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit",year:"numeric"}),c.textContent=e.message,a.setAttribute("data-name",e.name),i.appendChild(n),i.appendChild(d),a.appendChild(i),a.appendChild(c),t.insertBefore(a,s)}}}class n{constructor(e){this.target=e,this.websocket=null,this.sendMessage=this.sendMessage.bind(this),this.subscribeOnEvents=this.subscribeOnEvents.bind(this)}createWebSocket(){this.websocket=new WebSocket("ws://chat-backend-neda.onrender.com")}subscribeOnEvents(){this.websocket.addEventListener("open",(e=>{console.log("open",e)})),this.websocket.addEventListener("message",this.renderMessage.bind(this)),this.websocket.addEventListener("error",(e=>{console.log("error",e)})),this.websocket.addEventListener("close",(e=>{console.log("close",e)})),window.onunload=()=>{const e=this.user;this.websocket.send(JSON.stringify({type:"exit",user:e}))}}sendMessage(e){this.websocket.send(JSON.stringify(e))}renderMessage(e){const t=JSON.parse(e.data);Array.isArray(t)?this.target.displayUsers(t):this.target.displayMessage(t)}}const i=document.getElementById("root");new class{constructor(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e,this.api=new s,this.websocket=new n(this),this.view=new a(this),this.user=null,this.onClick=this.onClick.bind(this),this.displayUsers=this.displayUsers.bind(this),this.displayMessage=this.displayMessage.bind(this),this.onEnterChatHandler=this.onEnterChatHandler.bind(this)}init(){this.view.createStartModal()}onClick(e){e.preventDefault();const t=e.target;if(t.className.includes("next")){const e=t.closest(".modal"),s={name:e.querySelector(".input").value.trim()},a=t=>t&&"ok"===t.status?(this.user=t.user,e.remove(),this.view.createChat(),this.websocket.createWebSocket(),void this.websocket.subscribeOnEvents()):t&&"error"===t.status?(e.remove(),void this.view.createError(t.message)):void 0;this.api.create(s,a)}else if(t.className.includes("ok"))return t.closest(".modal").remove(),void this.view.createStartModal()}onEnterChatHandler(e){if(13===e.keyCode){const t=e.target,s=t.value;if(!s)return;const a=Date.now(),n=this.user.name;this.websocket.sendMessage({type:"send",name:n,date:a,message:s}),t.value=""}}displayUsers(e){const t=document.querySelector(".chat__userlist");t&&t.remove(),this.view.createUserList(e);const s=document.getElementById(this.user.id).querySelector(".chat__user-name");s.classList.add("chat__yourself"),s.textContent="YOU"}displayMessage(e){this.view.createCorrespondence(e);const t=document.querySelector(".chat__messages-container").querySelectorAll(`[data-name=${this.user.name}]`);t.length>0&&t.forEach((e=>{const t=e.querySelector(".message__header"),s=e.querySelector(".message__header_user-name");e.classList.add("message__container-yourself"),t.classList.add("message__header-yourself"),s.textContent="You"}))}}(i).init()}();